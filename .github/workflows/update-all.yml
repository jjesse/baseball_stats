name: Update All Stats (Complete Rebuild)

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for rebuild'
        required: false
        default: 'Scheduled rebuild'
        type: string

jobs:
  update-standings:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            # Fallback dependencies if requirements.txt is missing
            pip install pandas matplotlib seaborn requests beautifulsoup4 numpy lxml html5lib
          fi
      
      - name: Update standings
        run: |
          python standings_chart.py
        continue-on-error: true
      
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [[ -n $(git status --porcelain docs/*.json docs/*.png docs/*.html docs/*.txt) ]]; then
            git add docs/*.json docs/*.png docs/*.html docs/*.txt
            git commit -m "Update standings [skip ci]"
            git push
          else
            echo "No standings changes to commit"
          fi

  update-pitching:
    needs: update-standings
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            # Fallback dependencies
            pip install pybaseball pandas matplotlib seaborn
          fi
      
      - name: Update pitching stats
        run: |
          python pitching_chart.py
        continue-on-error: true
      
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [[ -n $(git status --porcelain) ]]; then
            git add docs/*.png docs/*.html docs/*.txt
            git commit -m "Update pitching stats [skip ci]"
            git push
          else
            echo "No pitching changes to commit"
          fi

  update-batting:
    needs: update-pitching
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            # Fallback dependencies
            pip install pybaseball pandas matplotlib seaborn
          fi
      
      - name: Update batting stats
        run: |
          python batting_chart.py
        continue-on-error: true
      
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [[ -n $(git status --porcelain) ]]; then
            git add docs/*.png docs/*.html docs/*.txt
            git commit -m "Update batting stats [skip ci]"
            git push
          else
            echo "No batting changes to commit"
          fi

  update-mvp-cy-young:
    needs: update-batting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            # Fallback dependencies
            pip install pandas matplotlib seaborn requests
          fi
      
      - name: Update MVP & Cy Young predictions
        run: |
          python mvp_cy_young_calculator.py
          python create_award_charts.py
        continue-on-error: true
      
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [[ -n $(git status --porcelain) ]]; then
            git add docs/*.json docs/*.png docs/*.csv
            git commit -m "Update MVP & Cy Young predictions [skip ci]"
            git push
          else
            echo "No award prediction changes to commit"
          fi

  update-playoffs:
    needs: update-mvp-cy-young
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            # Fallback dependencies
            pip install pandas matplotlib seaborn requests numpy
          fi
      
      - name: Update playoff predictions
        run: |
          python playoff_predictor.py
          python playoff_accuracy_tracker.py
        continue-on-error: true
      
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [[ -n $(git status --porcelain) ]]; then
            git add docs/playoff_*.json docs/playoff_*.png docs/playoff_*.html docs/playoff_prediction_history/*.json
            git commit -m "Update playoff predictions [skip ci]"
            git push
          else
            echo "No playoff prediction changes to commit"
          fi

  update-prediction-tracking:
    needs: update-playoffs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            # Fallback dependencies
            pip install pandas matplotlib seaborn numpy
          fi
      
      - name: Archive predictions
        run: |
          mkdir -p docs/prediction_history
          
          if [ -f "docs/award_predictions.json" ]; then
            cp docs/award_predictions.json docs/prediction_history/predictions_$(date +%F).json
            echo "âœ“ Archived today's predictions"
          else
            echo "Warning: No award predictions found to archive"
          fi
        continue-on-error: true
      
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [[ -n $(git status --porcelain) ]]; then
            git add docs/prediction_history/*.json
            git commit -m "Update prediction tracking [skip ci]"
            git push
          else
            echo "No prediction tracking changes to commit"
          fi